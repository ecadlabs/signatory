# Confidential Space Enclave Signer

Confidential Space backend is used in conjunction with [enclave-signer](https://github.com/ecadlabs/enclave-signer), its counterpart running inside [Google Cloud Confidential Space](https://cloud.google.com/confidential-computing/confidential-space), a secure execution environment that provides hardware-based memory encryption and integrity verification.

All keys imported into `enclave-signer` or generated by it never leave the enclave in a plain text form. As the enclave has no persistent storage, all sensitive data is stored by the parent instance in encrypted form. The keystone of this model is a carefully chosen [Google Cloud KMS](https://cloud.google.com/kms/) policy which permits the decryption of such data only by an actor possessing proper authentication credentials and running inside the Confidential Space environment.

## Prerequisites

For detailed setup instructions, see [GCP Confidential Space Setup Guide](gcp_confidentialspace_setup.md).

You will need:
- A Workload Identity Pool (WIP) Provider path for authentication
- A KMS encryption key path for encrypting/decrypting private keys
- Network access to the Confidential Space enclave running `enclave-signer`

## Configuration

| Field                | Environment variable | Type          | Default | Required | Description                                                  |
| -------------------- | -------------------- | ------------- | ------- | -------- | ------------------------------------------------------------ |
| host                 | CONFIDENTIAL_SPACE_HOST | string    |         | ✅        | Host address of the Confidential Space enclave running `enclave-signer` |
| port                 | CONFIDENTIAL_SPACE_PORT | string    | 2000    |          | TCP port of `enclave-signer` service                        |
| wip_provider_path    | GCP_WIP_PROVIDER_PATH | string        |         | ✅        | Workload Identity Pool Provider path for authentication          |
| encryption_key_path  | GCP_KMS_ENCRYPTION_KEY_PATH | string |         | ✅        | KMS key path used by enclave to encrypt/decrypt private keys |
| storage              |                      | StorageConfig |         |          | Key storage configuration                                    |

### StorageConfig

Encrypted keys may be stored locally in a JSON file.

| Field  | Type            | Description                               |
| ------ | --------------- | ----------------------------------------- |
| driver | string          | "file" (currently the only supported option) |
| config | string          | Full file path for key storage (optional) |

This block is optional. Local file `${BASE_DIR}/confidential_space_keys.json` will be used if the block is omitted.

#### Local storage

If local storage is specified then the `config` field is expected to be a single string containing a full file path. Environment variables are allowed and will be expanded.

## Example

For complete setup instructions, see [GCP Confidential Space Setup Guide](gcp_confidentialspace_setup.md).

```yaml
base_dir: ${HOME}/.signatory
server:
  # Address for the main HTTP server to listen on
  address: :6732
  # Address for the utility HTTP server to listen on
  utility_address: :9583

vaults:
  confidentialspace:
    driver: confidentialspace
    config:
      host: 10.0.0.100
      port: 2000
      wip_provider_path: projects/123456789/locations/global/workloadIdentityPools/my-pool/providers/my-provider
      encryption_key_path: projects/my-project/locations/global/keyRings/my-keyring/cryptoKeys/my-key
```

## Importing

Confidential Space backend supports importing of pre-existing plain text keys in either PEM, DER or Base58 format using `signatory-cli import` command. The key will be passed to the enclave in open form and the latter will return its encrypted version.

## Key Generation

More secure way of getting keys into the enclave is to generate them on the enclave side using `signatory-cli generate` command:

```
Usage:
  signatory-cli generate [flags]

Flags:
  -h, --help           help for generate
  -n, --num int        Number of keys to generate (default 1)
  -t, --type string    Key algorithm: [tz1, tz2, tz3, tz4, ed25519, secp256k1, p256, bls] (default "ed25519")
  -v, --vault string   Vault name for importing

Global Flags:
      --base-dir string   Base directory. Takes priority over one specified in config
  -c, --config string     Config file path (default "/etc/signatory.yaml")
      --json-log          Use JSON structured logs
      --log string        Log level: [error, warn, info, debug, trace] (default "info")
```

Example:

```
signatory-cli generate -v confidentialspace -t bls
```

## Security Model

The Confidential Space backend provides several security guarantees:

1. **Hardware-based isolation**: Keys are processed within Google Cloud's Confidential Space environment
2. **Memory encryption**: All memory accesses are encrypted and integrity-verified
3. **No persistent storage**: The enclave has no persistent storage, requiring external encrypted storage
4. **KMS integration**: Keys are encrypted using Google Cloud KMS before leaving the enclave
5. **Workload Identity**: Authentication is handled through Google Cloud Workload Identity Pool Provider

## Network Communication

The Confidential Space backend communicates with the enclave over TCP. The enclave must be accessible from the network where Signatory is running. The communication protocol is based on CBOR-encoded RPC messages for efficiency and security.

## Key Storage

Encrypted keys are stored in a JSON file with the following structure:

```json
[
  {
    "public_key_hash": "tz1...",
    "encrypted_private_key": "..."
  }
]
```

The `public_key_hash` field contains the Tezos address (Base58 encoded), and the `encrypted_private_key` field contains the KMS-encrypted private key data. 